<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test – USA & Germany real-time updates</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 1rem; }
    h1 { font-size: 1.25rem; margin-bottom: 0.25rem; }
    .meta { color: #666; font-size: 0.875rem; margin-bottom: 1rem; }
    #status { padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem; }
    #status.connected { background: #d1fae5; color: #065f46; }
    #status.disconnected { background: #fee2e2; color: #991b1b; }
    #status.loading { background: #fef3c7; color: #92400e; }
    .screens { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 640px) { .screens { grid-template-columns: 1fr; } }
    .screen { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .screen h2 { margin: 0; padding: 0.75rem 1rem; font-size: 1rem; }
    .screen.usa h2 { background: #dbeafe; color: #1e40af; }
    .screen.germany h2 { background: #fef3c7; color: #92400e; }
    .screen-events { max-height: 280px; overflow-y: auto; padding: 0.5rem; }
    .screen-events:empty::after { content: 'No events yet. Update an employee via HR API and process the event (e.g. make rabbitmq-pull-once).'; color: #9ca3af; font-size: 0.8125rem; display: block; padding: 1rem; }
    .event { padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.8125rem; background: #f9fafb; border: 1px solid #f3f4f6; }
    .event .name { color: #059669; font-weight: 600; }
    .event .payload { margin-top: 0.25rem; white-space: pre-wrap; word-break: break-all; font-size: 0.75rem; }
    .event time { color: #9ca3af; font-size: 0.7rem; }
  </style>
</head>
<body>
  <h1>WebSocket integration test</h1>
  <p class="meta">Subscribes to <code>checklist.USA</code>, <code>checklist.Germany</code>, <code>employees.USA</code>, <code>employees.Germany</code>. When HR employee events are processed by Hub, events appear in the matching country panel and in the console.</p>
  <div id="status" class="loading">Loading config…</div>

  <div class="screens">
    <section class="screen usa" aria-label="USA">
      <h2>USA</h2>
      <div id="events-usa" class="screen-events"></div>
    </section>
    <section class="screen germany" aria-label="Germany">
      <h2>Germany</h2>
      <div id="events-germany" class="screen-events"></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.4.0/dist/web/pusher.min.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const eventsByCountry = { USA: document.getElementById('events-usa'), Germany: document.getElementById('events-germany') };

      function countryFromChannel(channelName) {
        if (channelName.endsWith('.USA')) return 'USA';
        if (channelName.endsWith('.Germany')) return 'Germany';
        return null;
      }

      function addEvent(channelName, eventName, data) {
        const country = countryFromChannel(channelName);
        const container = country ? eventsByCountry[country] : null;
        if (!container) return;

        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML =
          '<span class="name">' + escapeHtml(eventName) + '</span> ' +
          '<time>' + new Date().toLocaleTimeString() + '</time>' +
          '<pre class="payload">' + escapeHtml(JSON.stringify(data, null, 2)) + '</pre>';
        container.insertBefore(div, container.firstChild);

        console.log('WebSocket event [' + (country || channelName) + ']:', eventName, data);
      }

      function escapeHtml(s) {
        const el = document.createElement('div');
        el.textContent = s;
        return el.innerHTML;
      }

      function setStatus(connected) {
        statusEl.textContent = connected ? 'Connected – listening for USA & Germany updates' : 'Disconnected';
        statusEl.className = connected ? 'connected' : 'disconnected';
      }

      const configUrl = (window.location.pathname.indexOf('/echo-test') !== -1)
        ? (window.location.origin + '/api/broadcasting/config')
        : (window.HUB_URL || 'http://localhost:9001') + '/api/broadcasting/config';

      fetch(configUrl)
        .then(function (r) { return r.json(); })
        .then(function (config) {
          if (!config.key) {
            statusEl.className = 'disconnected';
            statusEl.innerHTML =
              '<strong>Pusher not configured</strong><br><br>' +
              '1. Create a free app at <a href="https://dashboard.pusher.com/apps/new" target="_blank" rel="noopener">pusher.com</a><br>' +
              '2. In <code>hub-service/.env</code> set: <code>BROADCAST_CONNECTION=pusher</code>, <code>PUSHER_APP_ID</code>, <code>PUSHER_APP_KEY</code>, <code>PUSHER_APP_SECRET</code>, <code>PUSHER_APP_CLUSTER=mt1</code><br>' +
              '3. Restart Hub and reload this page.';
            return;
          }

          const options = { cluster: config.cluster || 'mt1', forceTLS: config.forceTLS !== false };
          if (config.wsHost) {
            options.wsHost = config.wsHost;
            options.wsPort = config.wsPort || 443;
            options.wssPort = config.wssPort || 443;
          }

          const pusher = new Pusher(config.key, options);
          pusher.connection.bind('connected', function () { setStatus(true); });
          pusher.connection.bind('disconnected', function () { setStatus(false); });
          pusher.connection.bind('error', function () { setStatus(false); });

          ['checklist.USA', 'checklist.Germany', 'employees.USA', 'employees.Germany'].forEach(function (channelName) {
            const ch = pusher.subscribe(channelName);
            ch.bind('ChecklistUpdated', function (data) { addEvent(channelName, 'ChecklistUpdated', data); });
            ch.bind('EmployeeDataUpdated', function (data) { addEvent(channelName, 'EmployeeDataUpdated', data); });
          });

          statusEl.textContent = 'Connecting…';
        })
        .catch(function (err) {
          statusEl.textContent = 'Failed to load config: ' + err.message;
          statusEl.className = 'disconnected';
        });
    })();
  </script>
</body>
</html>
